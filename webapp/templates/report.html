{% extends 'base.html' %}
{% block content %}
  <h2>Submit an Incident</h2>
  {% if reporter %}
    <article>
      <strong>Reporting as:</strong> {{ reporter.full_name }}<br />
      <small>{{ reporter.email }}{% if reporter.phone %} · {{ reporter.phone }}{% endif %}</small>
      {% if not can_submit %}
        <p style="color: #a00;">Your profile is inactive. Contact an administrator.</p>
      {% endif %}
    </article>
  {% else %}
    <article class="flash" data-theme="danger">
      Only vetted field officers can submit incidents. Use the dashboard for review or ask an administrator for access.
    </article>
  {% endif %}

  <form method="post">
    <label>
      Subject
      <input type="text" name="subject" value="{{ request.form.subject or '' }}" placeholder="Short summary (optional)" {% if not can_submit %}disabled{% endif %} />
    </label>
    <label>
      Message
      <textarea name="message" rows="6" placeholder="Describe the incident in detail..." {% if not can_submit %}disabled{% endif %} required>{{ request.form.message or '' }}</textarea>
    </label>
    <button type="submit" {% if not can_submit %}disabled{% endif %}>Classify & Save</button>
  </form>
  {% if not can_submit %}
    <small>Only active field officers can submit. Admins can re-enable your access from the reporter dashboard.</small>
  {% endif %}

  {% if prediction %}
    <h3>Latest Classification</h3>
    <div class="pred">
      <p><strong>Category:</strong> {{ prediction.label }}</p>
      {% if prediction.counselor %}
        <p><strong>Suggested counselor:</strong> {{ prediction.counselor.full_name }} ({{ prediction.counselor.email }})</p>
      {% endif %}
      {% if prediction.subject %}
        <p><strong>Subject:</strong> {{ prediction.subject }}</p>
      {% endif %}
      <p><strong>Message:</strong> {{ prediction.message }}</p>
    </div>
  {% endif %}

  {% if history %}
    <h3>Your Recent Reports</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Subject</th>
          <th>Category</th>
          <th>Confidence</th>
        </tr>
      </thead>
      <tbody>
        {% for row in history %}
          <tr>
            <td>{{ row.created_at }}</td>
            <td>{{ row.subject or '—' }}</td>
            <td>{{ row.predicted_label }}</td>
            <td>{{ '{:.2%}'.format(row.confidence) }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endblock %}
